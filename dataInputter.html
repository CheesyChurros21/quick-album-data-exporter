<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="albumDisplayer.css" >

        <title>
            Quick Album Database Inputter
        </title>

        <header class="websiteTitle">
            Quick Album Database Inputter
        </header>
        <br>
    </head>

    <body style="text-align: center;">
        <form>
            <label for="albumTitle">Album Title - </label>
            <input type="text" id="albumTitle" name="albumTitle" >
            <br>

            <label for="circleName">Circle Name - </label>
            <input type="text" id="circleName" name="circleName" >
            <br>

            <label for="albumPhoto">Album Photo - </label>
            <input type="text" id="albumPhoto" name="albumPhoto" >
            <br>

            <label for="dateCompleted">Date Completed - </label>
            <input type="datetime-local" id="dateCompleted" name="dateCompleted">
            <br>

            <label for="subjectiveJordan">Subjective Jordan Album Ranking - </label>
            <input type="number" id="subjectiveJordan" name="subjectiveJordan" min="1" max="20" step="0.5">
            <br>

            <label for="subjectiveNick">Subjective Nick Album Ranking - </label>
            <input type="number" id="subjectiveNick" name="subjectiveNick" min="1" max="20" step="0.5">
            <br>

            <label for="songAmount">Song Amount - </label>
            <input type="number" id="songAmount" name="songAmount" min="1" max="100" step="any" value="0">
            <br>

            <div id="ratingContainer"></div>
            <br>

        </form>

        <div id="averageDisplay">
            Jordan's Average: N/A | Nick's Average: N/A
        </div>
        <br>

        <div>
            <button id="submitAlbum" type="button">Submit Album Data</button>
            <pre id="albumDisplay"></pre>
        </div>
    </body>

    <script>
        const songAmount = document.getElementById("songAmount");
        const ratingContainer = document.getElementById("ratingContainer");

        let previousAmount = 0;

        songAmount.addEventListener("input", () => {
            let amount = parseInt(songAmount.value);

            //console.log("previous amount " + previousAmount);
            //console.log("amount " + amount);

            if (previousAmount > amount) {
                for (let i = previousAmount-1; i >= amount; i = i - 1) {
                    ratingContainer.removeChild(ratingContainer.children[i]);
                }
            }

            else if (!isNaN(amount) && amount > 0) {
                for (let i = previousAmount; i < amount; i = i + 1) {
                    const label = document.createElement("label");
                    label.textContent = `Rating For Song ${i + 1} - `;

                    const input = document.createElement("input");
                    input.name = `rating${i + 1}`;

                    if (document.getElementsByName(input.name).length == 0) {
                        let ratingDiv = document.createElement("div");
                        ratingDiv.style.display = "flex";
                        ratingDiv.style.justifyContent = "center";
                        ratingDiv.style.gap = "12px";

                        // Song Name
                        let songNameLabel = document.createElement("label");
                        songNameLabel.textContent = `Song ${i + 1} Name - `;
                        let songNameInput = document.createElement("input");
                        songNameInput.type = "text";
                        songNameInput.name = `songName${i + 1}`;

                        ratingDiv.appendChild(songNameLabel);
                        ratingDiv.appendChild(songNameInput);

                        // Jordan's rating
                        const jordanLabel = document.createElement("label");
                        jordanLabel.textContent = `Jordan Rating For Song ${i + 1} - `;
                        const jordanInput = document.createElement("input");
                        jordanInput.type = "number";
                        jordanInput.name = `jordanRating${i + 1}`;
                        jordanInput.min = "0";
                        jordanInput.max = "12";
                        jordanInput.step = "any";

                        ratingDiv.appendChild(jordanLabel);
                        ratingDiv.appendChild(jordanInput);

                        // Nick's rating
                        const nickLabel = document.createElement("label");
                        nickLabel.textContent = `Nick Rating For Song ${i + 1} - `;
                        const nickInput = document.createElement("input");
                        nickInput.type = "number";
                        nickInput.name = `nickRating${i + 1}`;
                        nickInput.min = "0";
                        nickInput.max = "12";
                        nickInput.step = "any";

                        ratingDiv.appendChild(nickLabel);
                        ratingDiv.appendChild(nickInput);

                        ratingContainer.appendChild(ratingDiv);
                    }
                }
            }

            previousAmount = amount;

            //console.log(ratingContainer);
        })

        function calculateAverage() {
            const jordanRatings = document.querySelectorAll("input[name^='jordanRating']");
            const nickRatings = document.querySelectorAll("input[name^='nickRating']");

            let jordanTotal = 0;
            let nickTotal = 0;

            let songAmount = parseInt(document.getElementById("songAmount").value);

            if (songAmount > 0) {
                jordanTotal = 0;
                nickTotal = 0;
                for (let i = 0; i < jordanRatings.length; i = i + 1) {
                    jordanTotal = jordanTotal + (parseFloat(jordanRatings[i].value) || 0);
                    nickTotal = nickTotal + (parseFloat(nickRatings[i].value) || 0);
                }

                let objectiveJordan = songAmount > 0 ? (jordanTotal / songAmount).toFixed(4) : "N/A";
                let objectiveNick = songAmount > 0 ? (nickTotal / songAmount).toFixed(4) : "N/A";

                document.getElementById("averageDisplay").textContent = `Jordan's Average: ${objectiveJordan} | Nick's Average: ${objectiveNick}`;
            }   
        }

        
        document.body.addEventListener("input", (e) => {
            console.log("here");
            if (e.target.name?.startsWith("jordanRating") || e.target.name?.startsWith("nickRating")) {
                calculateAverage();
            }
        });


        document.getElementById("submitAlbum").addEventListener("click", () => {
            const albumTitle = document.getElementById("albumTitle").value.trim();    
            const circleName = document.getElementById("circleName").value.trim();
            const albumPhoto = document.getElementById("albumPhoto").value.trim();
            const dateCompleted = document.getElementById("dateCompleted").value;
            const subjectiveJordan = parseFloat(document.getElementById("subjectiveJordan").value) || 0;
            const subjectiveNick = parseFloat(document.getElementById("subjectiveNick").value) || 0;
            const songAmount = parseInt(document.getElementById("songAmount").value);
            const songNames = document.querySelectorAll("input[name^='songName']");
            const jordanRatings = document.querySelectorAll("input[name^='jordanRating']");
            const nickRatings = document.querySelectorAll("input[name^='nickRating']");

            let jordanTotal = 0;
            let nickTotal = 0;

            const ratings = [];

            if (songAmount > 0) {
                for (let i = 0; i < jordanRatings.length; i = i + 1) {
                    jordanTotal = jordanTotal + (parseFloat(jordanRatings[i].value) || 0);
                    nickTotal = nickTotal + (parseFloat(nickRatings[i].value) || 0);

                    ratings.push({
                        songNumber: i + 1,
                        songName: songNames[i].value.trim() || "",
                        jordanRating: (parseFloat(jordanRatings[i].value) || 0),
                        nickRating: (parseFloat(nickRatings[i].value) || 0)
                    });

                }

                let objectiveJordan = songAmount > 0 ? (jordanTotal / songAmount).toFixed(4) : "N/A";
                let objectiveNick = songAmount > 0 ? (nickTotal / songAmount).toFixed(4) : "N/A";


                const albumData = {
                    albumTitle,
                    circleName,
                    albumPhoto,
                    dateCompleted,
                    subjectiveJordan,
                    subjectiveNick,
                    songAmount,
                    objectiveJordan,
                    objectiveNick,
                    ratings
                };

                document.getElementById("albumDisplay").textContent = JSON.stringify(albumData, null, 2);
                
                const blob = new Blob([JSON.stringify(albumData, null, 2)], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${albumTitle.replace(/\\s+/g, '_')}.json`;
                link.click();

            } 
        })
    </script>
</html>
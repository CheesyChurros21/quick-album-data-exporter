<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="albumDisplayer.css" >

        <title>
            Quick Album Database Inputter
        </title>

        <header class="websiteTitle">
            Quick Album Database Inputter
        </header>
        <br>
    </head>

    <body style="text-align: center;">
        <form>
            <label for="isRerank">Is Rerank? </label>
            <input type="checkbox" id="albumRerank" name="albumRerank">
        </form>

        <select id="albumDropdown" name="albumDropdown" style="visibility: hidden;">
            <option value="None">None</option>
        </select>

        <br><br><br>

        <form>
            <label for="albumTitle">Album Title - </label>
            <input type="text" id="albumTitle" name="albumTitle" >
            <br>

            <label for="circleName">Circle Name - </label>
            <input type="text" id="circleName" name="circleName" >
            <br>

            <label for="albumPhoto">Album Photo - </label>
            <input type="text" id="albumPhoto" name="albumPhoto" >
            <br>

            <label for="dateCompleted">Date Completed - </label>
            <input type="datetime-local" id="dateCompleted" name="dateCompleted">
            <br>

            <label for="subjectiveJordan">Subjective Jordan Album Ranking - </label>
            <input type="number" id="subjectiveJordan" name="subjectiveJordan" min="1" max="20" step="0.5">
            <br>

            <label for="subjectiveNick">Subjective Nick Album Ranking - </label>
            <input type="number" id="subjectiveNick" name="subjectiveNick" min="1" max="20" step="0.5">
            <br>

            <label for="songAmount">Song Amount - </label>
            <input type="number" id="songAmount" name="songAmount" min="1" max="100" step="any" value="0">
            <br>

            <div id="ratingContainer"></div>
            <br>

        </form>

        <div id="averageDisplay">
            Jordan's Average: N/A | Nick's Average: N/A
        </div>
        <br>

        <div>
            <button id="submitAlbum" type="button">Submit Album Data</button>
            <pre id="albumDisplay"></pre>
        </div>
    </body>

    <script>
        const songAmount = document.getElementById("songAmount");
        const ratingContainer = document.getElementById("ratingContainer");

        let previousAmount = 0;

        songAmount.addEventListener("input", () => {
            let amount = parseInt(songAmount.value);

            //console.log("previous amount " + previousAmount);
            //console.log("amount " + amount);

            if (previousAmount > amount) {
                for (let i = previousAmount-1; i >= amount; i = i - 1) {
                    ratingContainer.removeChild(ratingContainer.children[i]);
                }
            }

            else if (!isNaN(amount) && amount > 0) {
                for (let i = previousAmount; i < amount; i = i + 1) {
                    const label = document.createElement("label");
                    label.textContent = `Rating For Song ${i + 1} - `;

                    const input = document.createElement("input");
                    input.name = `rating${i + 1}`;

                    if (document.getElementsByName(input.name).length == 0) {
                        let ratingDiv = document.createElement("div");
                        ratingDiv.style.display = "flex";
                        ratingDiv.style.justifyContent = "center";
                        ratingDiv.style.gap = "12px";

                        // Song Name
                        let songNameLabel = document.createElement("label");
                        songNameLabel.textContent = `Song ${i + 1} Name - `;
                        let songNameInput = document.createElement("input");
                        songNameInput.type = "text";
                        songNameInput.name = `songName${i + 1}`;

                        ratingDiv.appendChild(songNameLabel);
                        ratingDiv.appendChild(songNameInput);

                        // Jordan's rating
                        const jordanLabel = document.createElement("label");
                        jordanLabel.textContent = `Jordan Rating For Song ${i + 1} - `;
                        const jordanInput = document.createElement("input");
                        jordanInput.type = "number";
                        jordanInput.name = `jordanRating${i + 1}`;
                        jordanInput.min = "-1";
                        jordanInput.max = "12";
                        jordanInput.step = "any";

                        ratingDiv.appendChild(jordanLabel);
                        ratingDiv.appendChild(jordanInput);

                        // Nick's rating
                        const nickLabel = document.createElement("label");
                        nickLabel.textContent = `Nick Rating For Song ${i + 1} - `;
                        const nickInput = document.createElement("input");
                        nickInput.type = "number";
                        nickInput.name = `nickRating${i + 1}`;
                        nickInput.min = "-1";
                        nickInput.max = "12";
                        nickInput.step = "any";

                        ratingDiv.appendChild(nickLabel);
                        ratingDiv.appendChild(nickInput);

                        ratingContainer.appendChild(ratingDiv);
                    }
                }
            }

            previousAmount = amount;

            //console.log(ratingContainer);
        })

        function calculateAverage() {
            const jordanRatings = document.querySelectorAll("input[name^='jordanRating']");
            const nickRatings = document.querySelectorAll("input[name^='nickRating']");

            let jordanTotal = 0;
            let nickTotal = 0;
            let jordanUnavailableSongTotal = 0;
            let nickUnavailableSongTotal = 0;

            let songAmount = parseInt(document.getElementById("songAmount").value);

            if (songAmount > 0) {
                jordanTotal = 0;
                nickTotal = 0;
                for (let i = 0; i < jordanRatings.length; i = i + 1) {

                    if (parseFloat(jordanRatings[i].value) >= 0) {
                        jordanTotal = jordanTotal + (parseFloat(jordanRatings[i].value) || 0);
                    }

                    else {
                        jordanUnavailableSongTotal = jordanUnavailableSongTotal + 1;
                    }
                    
                    if (parseFloat(nickRatings[i].value) >= 0) {
                        nickTotal = nickTotal + (parseFloat(nickRatings[i].value) || 0);
                    }
                    
                    else {
                        nickUnavailableSongTotal = nickUnavailableSongTotal + 1;
                    }
                }

                let objectiveJordan = songAmount > 0 ? (jordanTotal / (songAmount - jordanUnavailableSongTotal)).toFixed(4) : "N/A";
                let objectiveNick = songAmount > 0 ? (nickTotal / (songAmount - nickUnavailableSongTotal)).toFixed(4) : "N/A";

                document.getElementById("averageDisplay").textContent = `Jordan's Average: ${objectiveJordan} | Nick's Average: ${objectiveNick}`;
            }   
        }

        
        document.body.addEventListener("input", (e) => {
            console.log("here");
            if (e.target.name?.startsWith("jordanRating") || e.target.name?.startsWith("nickRating")) {
                calculateAverage();
            }
        });


        document.getElementById("submitAlbum").addEventListener("click", () => {
            const albumTitle = document.getElementById("albumTitle").value.trim();    
            const circleName = document.getElementById("circleName").value.trim();
            const albumPhoto = document.getElementById("albumPhoto").value.trim();
            const dateCompleted = document.getElementById("dateCompleted").value;
            let subjectiveJordan = parseFloat(document.getElementById("subjectiveJordan").value) || -1;
            let subjectiveNick = parseFloat(document.getElementById("subjectiveNick").value) || -1;
            const songAmount = parseInt(document.getElementById("songAmount").value);
            const songNames = document.querySelectorAll("input[name^='songName']");
            const jordanRatings = document.querySelectorAll("input[name^='jordanRating']");
            const nickRatings = document.querySelectorAll("input[name^='nickRating']");

            let jordanTotal = 0;
            let nickTotal = 0;
            let jordanUnavailableSongTotal = 0;
            let nickUnavailableSongTotal = 0;
            let jordanCurrentRating = 0;
            let nickCurrentRating = 0;

            const ratings = [];

            if (songAmount > 0) {
                for (let i = 0; i < jordanRatings.length; i = i + 1) {
                    if (parseFloat(jordanRatings[i].value) >= 0) {
                        jordanCurrentRating = parseFloat(jordanRatings[i].value);
                        jordanTotal = jordanTotal + (jordanCurrentRating || 0);
                    }

                    else {
                        jordanCurrentRating = "N/A";
                        jordanUnavailableSongTotal = jordanUnavailableSongTotal + 1;
                    }

                    if (parseFloat(nickRatings[i].value) >= 0) {
                        nickCurrentRating = parseFloat(nickRatings[i].value);
                        nickTotal = nickTotal + (nickCurrentRating || 0);
                    }

                    else {
                        nickCurrentRating = "N/A";
                        nickUnavailableSongTotal = nickUnavailableSongTotal + 1;
                    }

                    ratings.push({
                        songNumber: i + 1,
                        songName: songNames[i].value.trim() || "",
                        jordanRating: (jordanCurrentRating || "N/A"),
                        nickRating: (nickCurrentRating || "N/A")
                    });

                }

                let objectiveJordan = songAmount > 0 ? parseFloat((jordanTotal / (songAmount - jordanUnavailableSongTotal)).toFixed(4)) : "N/A";
                let objectiveNick = songAmount > 0 ? parseFloat((nickTotal / (songAmount - nickUnavailableSongTotal)).toFixed(4)) : "N/A";


                let objectiveCombined;
                let subjectiveCombined;

                if (objectiveJordan !== "N/A" && objectiveNick !== "N/A") {
                    objectiveCombined = ((parseFloat(objectiveJordan) + parseFloat(objectiveNick)) / 2).toFixed(4);
                } 
                
                else {
                    objectiveCombined = "N/A";
                }

                if (subjectiveJordan >= 0 && subjectiveNick >= 0) {
                    subjectiveCombined = ((parseFloat(subjectiveJordan) + parseFloat(subjectiveNick)) / 2).toFixed(4);
                } 
                
                else {
                    if (subjectiveJordan < 0) {
                        subjectiveJordan = objectiveJordan;
                    }

                    if (subjectiveNick < 0) {
                        subjectiveNick = objectiveNick;
                    }

                    subjectiveCombined = ((parseFloat(subjectiveJordan) + parseFloat(subjectiveNick)) / 2).toFixed(4);
                }

                const albumData = {
                    albumTitle,
                    circleName,
                    albumPhoto,
                    dateCompleted,
                    subjectiveJordan,
                    subjectiveNick,
                    objectiveJordan,
                    objectiveNick,
                    subjectiveCombined,
                    objectiveCombined,
                    songAmount,
                    ratings
                };

                document.getElementById("albumDisplay").textContent = JSON.stringify(albumData, null, 2);
                
                const blob = new Blob([JSON.stringify(albumData, null, 2)], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${albumTitle.replace(/\\s+/g, '_')}.json`;
                link.click();

            } 
        })

        const rerankCheckbox = document.getElementById("albumRerank");

        let albums = [];
        let albumDropdown = document.getElementById("albumDropdown");

        fetch('all_albums.json')
        .then(response => response.json())
        .then(data => {
            const uniqueMap = new Map();
            data.forEach(entry => {
                const lower = entry.albumTitle.toLowerCase();
                if (!uniqueMap.has(lower)) {
                    uniqueMap.set(lower, entry);
                }
            })

            albums = Array.from(uniqueMap.values());

            albums.sort((a, b) => a.albumTitle.localeCompare(b.albumTitle, "en", {"sensitivity" : "base"}))

            for (let i = 0; i < albums.length; i = i + 1) {
                let album = document.createElement("option");
                album.value = albums[i].albumTitle;
                album.textContent = albums[i].albumTitle;
                albumDropdown.appendChild(album);
            }
        })
        .catch(error => console.error('Error loading JSON:', error));

        rerankCheckbox.addEventListener("change", () => {
            if (rerankCheckbox.checked) {
                albumDropdown.style.visibility = "visible";
            }

            else {
                albumDropdown.style.visibility = "hidden";
            }
        })

    albumDropdown.addEventListener("change", () => {
    const selectedTitle = albumDropdown.value.toLowerCase();
    const selectedAlbum = albums.find(entry => entry.albumTitle.toLowerCase() === selectedTitle);

    if (selectedAlbum) {
        // Fill basic fields
        document.getElementById("albumTitle").value = selectedAlbum.albumTitle;
        document.getElementById("circleName").value = selectedAlbum.circleName;
        document.getElementById("albumPhoto").value = selectedAlbum.albumPhoto;
        document.getElementById("songAmount").value = selectedAlbum.songAmount;

        // Trigger songAmount input event to generate rating fields
        songAmount.dispatchEvent(new Event("input"));

        // Wait a moment for fields to render, then populate them
        setTimeout(() => {
            selectedAlbum.ratings.forEach((rating, i) => {
                document.querySelector(`input[name='songName${i + 1}']`).value = rating.songName;
            });
        }, 50); // Slight delay to ensure fields are rendered
    }
});
    </script>
</html>